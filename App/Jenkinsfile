pipeline {
    agent any

    environment {
        // --- PATH SETTINGS (From your previous setup) ---
        PATH         = "/usr/local/bin:/opt/homebrew/bin:/usr/bin:/bin:/usr/sbin:/sbin:$PATH"

        // --- GCP / CLOUD SETTINGS ---
        PROJECT_ID   = 'flask-app-gke-project'
        LOCATION     = 'us-central1'
        REPO_PATH    = 'us-central1-docker.pkg.dev/flask-app-gke-project/test-repo'
        IMAGE_NAME   = 'simple-app'
        CLUSTER_NAME = 'flask-cluster' 
        
        // --- CREDENTIALS ID ---
        // Ensure you have a 'Secret File' credential in Jenkins with this exact ID
        GCP_CREDS_ID = 'gcp-key'
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'Pulling latest code from GitHub...'
                checkout scm
            }
        }

        stage('Build and Push Image') {
            steps {
                echo 'Authenticating and Building Docker Image...'
                withCredentials([file(credentialsId: "${GCP_CREDS_ID}", variable: 'GCP_KEY')]) {
                    // 1. Authenticate with Google Cloud
                    sh "gcloud auth activate-service-account --key-file=${GCP_KEY}"
                    sh "gcloud auth configure-docker ${LOCATION}-docker.pkg.dev --quiet"

                    // 2. Build the image (Moving into 'App' folder where your 'container' file is)
                    dir('App') {
                        sh "docker build -t ${REPO_PATH}/${IMAGE_NAME}:${BUILD_NUMBER} -f container ."
                    }
                    
                    // 3. Push to Artifact Registry
                    sh "docker push ${REPO_PATH}/${IMAGE_NAME}:${BUILD_NUMBER}"
                }
            }
        }

        stage('Deploy to GKE with Helm') {
		    steps {
		        echo 'Deploying to GKE Cluster via Helm...'
		        withCredentials([file(credentialsId: "${GCP_CREDS_ID}", variable: 'GCP_KEY')]) {
		            // 1. Connect kubectl/helm to your GKE cluster
		            sh "gcloud auth activate-service-account --key-file=${GCP_KEY}"
		            sh "gcloud container clusters get-credentials ${CLUSTER_NAME} --region ${LOCATION} --project ${PROJECT_ID}"
		
		            // 2. Run Helm Upgrade/Install
		            // Added --timeout 15m and --atomic=false to prevent premature failure
		            sh """
		            helm upgrade --install flask-app-release ./flask-chart \
		                --set image.repository=${REPO_PATH}/${IMAGE_NAME} \
		                --set image.tag=${BUILD_NUMBER} \
		                --wait \
		                --timeout 15m \
		                --atomic=false
		            """
		        }
		    }
		}
        stage('Post-Deployment Verification') {
            steps {
                echo 'Fetching the External IP of your application...'
                // This gives GCP a moment to provision the LoadBalancer IP
                sleep 10
                sh "kubectl get service flask-app-release-flask-chart" 
            }
        }
    }

    post {
        success {
            echo "SUCCESS: Version ${BUILD_NUMBER} is now live on GKE."
        }
        failure {
            echo "FAILURE: Deployment failed. Please check the logs below."
            // Try to get logs from one of the pods if deployment fails
            sh "kubectl logs -l app.kubernetes.io/instance=flask-app-release --tail=20 || true"
        }
    }
}
